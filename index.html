<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>License Plate Scanner</title>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; text-align: center; background: #121212; color: #e0e0e0; padding: 20px; margin: 0; }
        h2 { margin-bottom: 10px; color: #fff; }
        
        /* Video Container */
        .video-container { position: relative; width: 100%; max-width: 400px; margin: 0 auto; border: 3px solid #333; border-radius: 12px; overflow: hidden; background: #000; }
        video { width: 100%; display: block; }
        canvas { display: none; }
        
        /* Guide Box overlay to help user aim */
        .guide-box {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            width: 80%; height: 30%;
            border: 2px solid rgba(255, 255, 255, 0.5);
            box-shadow: 0 0 0 1000px rgba(0, 0, 0, 0.5);
            pointer-events: none;
        }
        
        /* Controls */
        .controls { margin-top: 20px; display: grid; grid-template-columns: 1fr 1fr; gap: 15px; max-width: 400px; margin-left: auto; margin-right: auto; }
        button { padding: 18px; font-size: 16px; font-weight: bold; border: none; border-radius: 12px; cursor: pointer; transition: transform 0.1s; }
        button:active { transform: scale(0.98); }
        
        #btn-log { background-color: #3498db; color: white; }
        #btn-check { background-color: #f1c40f; color: black; }
        
        /* Status Display */
        #status-container { margin-top: 25px; min-height: 60px; max-width: 400px; margin-left: auto; margin-right: auto; }
        #status { padding: 15px; border-radius: 8px; font-weight: bold; background: #222; border: 1px solid #333; }
        
        .loading { color: #aaa; font-style: italic; }
        .success { background-color: #2ecc71 !important; color: white; border-color: #2ecc71 !important; }
        .alarm { background-color: #e74c3c !important; color: white; border-color: #e74c3c !important; }
        .clean { background-color: #27ae60 !important; color: white; border-color: #27ae60 !important; }
    </style>
</head>
<body>

    <h2>Plate Scanner</h2>
    
    <div class="video-container">
        <video id="video" playsinline autoplay></video>
        <div class="guide-box"></div> </div>
    <canvas id="canvas"></canvas>

    <div class="controls">
        <button id="btn-log" onclick="captureAndSend('log')">Log Plate</button>
        <button id="btn-check" onclick="captureAndSend('check')">Check System</button>
    </div>

    <div id="status-container">
        <div id="status">Ready to scan</div>
    </div>

    <script>
        // YOUR BACKEND URL
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycby3WxJ-1EJR5OBSISLU4KBNuJp4Xu7mAfqBV_4iiqPiQrvIBX0-wFS_a3lKKAV8ZNdJ/exec";

        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const statusDiv = document.getElementById('status');

        // 1. Initialize Camera
        async function startCamera() {
            try {
                // Request the back-facing camera
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: { exact: "environment" } } 
                }).catch(() => {
                    // Fallback if "exact" fails
                    return navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
                });
                video.srcObject = stream;
            } catch (err) {
                statusDiv.innerText = "Camera Error: " + err.message;
                statusDiv.className = "alarm";
            }
        }

        // 2. Capture Image & Process
        async function captureAndSend(mode) {
            // UI Feedback
            statusDiv.innerText = "Processing image...";
            statusDiv.className = "loading";

            // Draw current video frame to hidden canvas
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

            try {
                // OCR Step (Tesseract.js)
                const { data: { text } } = await Tesseract.recognize(canvas, 'eng');
                
                // Cleanup Text: Remove everything except letters and numbers
                const cleanPlate = text.replace(/[^a-zA-Z0-9]/g, "").toUpperCase();

                if (cleanPlate.length < 3) {
                    statusDiv.innerText = "No text found. Try getting closer.";
                    statusDiv.className = "";
                    return;
                }

                statusDiv.innerText = `Found: ${cleanPlate}. Sending...`;
                
                // Send to Google Sheet
                await sendToSheet(cleanPlate, mode);

            } catch (err) {
                statusDiv.innerText = "Error: " + err.message;
            }
        }

        // 3. Send to Backend
        async function sendToSheet(plate, mode) {
            // Note: We use 'no-cors' to avoid browser security errors with Google Scripts.
            // This means we CANNOT read the response text (like "Found" or "Not Found") easily.
            // Data WILL save to the sheet, but the phone won't know the result confirmation.
            
            const payload = JSON.stringify({ plate: plate, mode: mode });

            try {
                await fetch(SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors', 
                    headers: { 'Content-Type': 'application/json' },
                    body: payload
                });

                // Optimistic UI updates since we can't read the response in 'no-cors' mode
                if (mode === 'log') {
                    statusDiv.innerText = `Logged: ${plate}`;
                    statusDiv.className = "success";
                } else {
                    statusDiv.innerText = `Checked: ${plate} (See Sheet)`;
                    statusDiv.className = "clean";
                }
                
            } catch (error) {
                statusDiv.innerText = "Network Error";
                statusDiv.className = "alarm";
            }
        }

        startCamera();
    </script>
</body>
</html>
